{% extends "base.html" %}

{% block title %}Voter Authentication - Smart Voting System{% endblock %}

{% block content %}
<div class="container mt-4" id="authContainer">
    <h1>Voter Authentication</h1>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Face Authentication Required</h5>
                    <p>Please provide your Voter ID and verify your identity using the webcam.</p>
                    
                    <div class="mb-3">
                        <label for="voter_id" class="form-label">Voter ID</label>
                        <input type="text" class="form-control" id="voter_id" placeholder="Enter your Voter ID">
                    </div>
                    
                    <div class="mb-3 text-center">
                        <video id="webcam" width="640" height="480" autoplay style="border: 2px solid #ccc; border-radius: 8px;"></video>
                    </div>
                    
                    <button class="btn btn-primary" id="startAuth">Start Webcam</button>
                    <button class="btn btn-success" id="captureVerify" style="display: none;">Capture & Verify</button>
                    <div id="statusMessage" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<audio id="beepSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSV+zPDTgjMGHm7A7+OZTRENS6nm8bllHAU2jdXwzHkrBSd+zPDTgjMGHW/A7+OZTA" type="audio/wav">
</audio>

<style>
.red-blink {
    animation: blink-red 0.5s infinite;
}

@keyframes blink-red {
    0%, 100% { background-color: #ff0000; }
    50% { background-color: #ffffff; }
}

.success-alert {
    background-color: #28a745;
    color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    font-size: 1.2em;
    margin-top: 20px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let webcamStream = null;
let video = document.getElementById('webcam');

document.getElementById('startAuth').addEventListener('click', async function() {
    try {
        webcamStream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
        video.srcObject = webcamStream;
        document.getElementById('captureVerify').style.display = 'inline-block';
        this.style.display = 'none';
    } catch (error) {
        alert('Unable to access webcam: ' + error.message);
    }
});

document.getElementById('captureVerify').addEventListener('click', function() {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg').split(",")[1];
    const voterId = document.getElementById('voter_id').value.trim();
    
    if (!voterId) {
        alert('Please enter your Voter ID');
        return;
    }
    
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.innerHTML = '<div class="alert alert-info">Verifying your identity...</div>';
    
    // Send verification request
    fetch('/poll/auth/verify', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ 
        voter_id: voterId, 
        image_data: imageData 
    })
    })
    .then(async response => {
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            return response.json();
        } else {
            const text = await response.text();
            throw new Error("Server did not return JSON. Response was: " + text.substring(0, 200));
        }
    })
    .then(data => {
        if (data.success) {
            // Success - green alert
            statusDiv.innerHTML = '<div class="success-alert">✓ Authentication Successful! Redirecting to voting...</div>';
            
            // Stop webcam
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }
            
            // Redirect after 2 seconds
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 2000);
        } else if (data.fake_face) {
            // Fake face detected - red blinking alert + beep
            triggerFakeFaceAlert();
            statusDiv.innerHTML = '<div class="alert alert-danger"><strong>⚠ FAKE FACE DETECTED!</strong><br>' + 
                                 'Security alert has been sent. Distance: ' + (data.distance || 'N/A') + '</div>';
        } else {
            // Other error
            statusDiv.innerHTML = '<div class="alert alert-warning">' + data.message + '</div>';
        }
    })
    .catch(error => {
        statusDiv.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
    });
});

function triggerFakeFaceAlert() {
    const container = document.getElementById('authContainer');
    const beep = document.getElementById('beepSound');
    
    // Add red blinking effect
    container.classList.add('red-blink');
    
    // Play beep sound (loop for 5 seconds)
    beep.loop = true;
    beep.play();
    
    // Stop after 5 seconds
    setTimeout(() => {
        container.classList.remove('red-blink');
        beep.pause();
        beep.currentTime = 0;
        beep.loop = false;
    }, 5000);
}
</script>
{% endblock %}
